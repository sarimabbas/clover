import { Callout } from "nextra-theme-docs";
import { Tab, Tabs } from "nextra-theme-docs";

# Clover ‚òòÔ∏è

Server routes augmented with Zod and OpenAPI

<br />

<img
  src="/cover.png"
  style={{
    width: 400,
    height: 400,
    borderRadius: 10,
  }}
/>

> Cover from Midjourney

<Callout type="warning" emoji="‚ö†Ô∏è">
  If you find inaccuracies or anything missing, please open an issue on GitHub!
</Callout>

## Installation

<Tabs items={["pnpm", "npm", "yarn"]}>
  <Tab>

```bash
pnpm i @sarim.garden/clover
```

  </Tab>
  <Tab>

```bash
npm i @sarim.garden/clover
```

  </Tab>
  <Tab>

```bash
yarn add @sarim.garden/clover
```

  </Tab>
</Tabs>

## Introduction

Clover is a library that allows you to define your server routes using Zod and OpenAPI. You can use Clover for making your server routes type-safe and self-documenting, and as a lighterweight TRPC/Zodios replacement.

You can use Clover with any framework/runtime that supports WinterCG style functions e.g. here's an example with Next.js App Router:

```ts
// example Next.js route handler
// app/hello/route.ts

const handler = (request: Request) => {
  return new Response("Hello World!");
};

export { handler as GET };
```

### Server

Here's what a handler augmented with Clover looks like:

```ts
// app/hello/route.ts
import { makeRequestHandler } from "@sarim.garden/clover";
import { z } from "zod";

export const { handler } = makeRequestHandler({
  method: "GET",
  path: "/hello",
  description: "Returns a greeting",
  input: z.object({
    name: z.string(),
  }),
  output: z.object({
    greeting: z.string(),
  }),
  run: async ({ input, sendOutput }) => {
    return sendOutput({
      greeting: `Hello ${input.name}!`,
    });
  },
});

export { handler as GET };
```

You can learn more about how to add authentication, about Clover's heuristics for query parameters, path parameters, request bodies etc. by reading the server guide in the sidebar üëà

### Client

Clover also provides an optional client fetcher. It's nothing fancy, it just wraps the Fetch API and provides type safety.

```ts
// app/hello/route.ts

export const { handler, clientTypes } = makeRequestHandler({
  // ...same as above
});

// client.ts

import { makeFetcher } from "@sarim.garden/clover";

const fetcher = makeFetcher({
  baseUrl: "https://example.com",
});

const { greeting } = await fetcher<typeof clientTypes>({
  input: {
    name: "Sarim",
  },
});
```

You can use the fetcher inside pure backend (server-to-server), backend-for-frontend (e.g. React Server Components), and frontend contexts (e.g. TanStack Query). You can read more about how the fetcher works in the sidebar üëà

### OpenAPI

You can generate OpenAPI documentation from your server routes.

```ts
// app/hello/route.ts

export const { handler, openAPIPathsObject } = makeRequestHandler({
  // ...same as above
});

// openapi.ts
import { OpenAPIObject, OpenAPIPathsObject } from "@sarim.garden/clover";
import { openAPIPathsObject } from "../hello/route";

// it's ugly, I know, but this nicely combines
// multiple openAPI definitions from different route handlers :)
const pathsObject: OpenAPIPathsObject = [
  openAPIPathsObject,
  // ...add others here
].reduce((acc, curr) => {
  Object.keys(curr).forEach((k) => {
    acc[k] = {
      ...acc[k],
      ...curr[k],
    };
  });
  return acc;
}, {});

export const document: OpenAPIObject = {
  info: {
    title: "My API",
    version: "1.0.0",
  },
  openapi: "3.0.0",
  paths: pathsObject,
};
```

You can now serve this JSON document, and use it with Swagger UI or similar tools. You can learn more about how to do that by reading the full OpenAPI guide in the sidebar üëà

## Credits

### Similar projects

- TRPC: https://github.com/trpc/trpc
- Zodios: https://github.com/ecyrbe/zodios
- ts-rest: https://github.com/ts-rest/ts-rest
- feTS: https://github.com/ardatan/fets
- zaCT: https://github.com/pingdotgg/zact

### Enabling libraries

- Zod: https://github.com/colinhacks/zod/
- @anatine/zod-openapi: https://github.com/anatine/zod-plugins
- OpenApi3-TS: https://github.com/metadevpro/openapi3-ts
